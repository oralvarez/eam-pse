{% extends "tema3/base.html" %}  

{% block page_header %}
	<p>		<a class="btn btn-success btn-sm" role="button" href="/nav/abastecimiento/productos/1">Regresar</a>
</p>
{% endblock page_header %}
 
{% block contenido %}
{% verbatim %}
<div ng-controller="editController" class="panel panel-green">
    <div class="panel-heading">
				<h3 class="panel-title">Detalle de servicio</h3>
			</div>
    <div class="panel-body"
	<div class="row">

    <form class="form" role="form" ng-submit="submit()">
        <div class="row">
            <div class="col-lg-12">
                <p ng-repeat="(name, errs) in errors" class="alert alert-danger"><strong>{{ name }}</strong>: {{ errs.join(', ') }}</p>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="form-group">
                    <select ng-model="Producto.tipo_producto" class="form-control" ng-options="tipoproducto.id as tipoproducto.nombre for tipoproducto in tipoproductos" id="cmb_tipo_producto">
                    </select>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.consecutivo" placeholder="Consecutivo" disabled>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.fecha_registro" placeholder="Fecha de Registro" disabled>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.estado" placeholder="Estado" disabled>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="form-group">
                    <select ng-model="Producto.usuario" class="form-control" ng-options="user.id as user.username for user in users" id="cmb_usuario">
                    </select>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="form-group" ng-if="Producto.tipo_producto == '5' || Producto.tipo_producto == '6' || Producto.tipo_producto == '2' || Producto.tipo_producto == '1'">
                    <input type="text" class="form-control" ng-model="Producto.fecha_requerido" placeholder="Fecha de Requerido">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-6">
                <div class="form-group">
                    Â¿Es Secreto?: <input type="checkbox" class="checkbox-info" ng-model="Producto.es_secreto" placeholder="Es Secreto?">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12" ng-if="Producto.tipo_producto == '5' || Producto.tipo_producto == '10' || Producto.tipo_producto == '1' || Producto.tipo_producto == '7'">
                <div class="form-group">
                    <textarea class="form-control" ng-model="Producto.objeto" placeholder="Objeto" ></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.localizacion" placeholder="Localizacion">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="form-group">
                    <textarea class="form-control" ng-model="Producto.observaciones" placeholder="Observaciones" ></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '6'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.numero_proceso" placeholder="Numero de Proceso">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '2'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.nivel_inteligencia" placeholder="Nivel de Inteligencia">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12" ng-if="Producto.tipo_producto == '2'">
                <div class="form-group" >
                    <textarea class="form-control" ng-model="Producto.descripcion_bien_servicio" placeholder="Descripcion del Bien o Servicio" ></textarea>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '2'">
                <div class="form-group" >
                    <select ng-model="Producto.tipo_ubicacion" class="form-control" ng-options="tipoubicacion.id as tipoubicacion.nombre for tipoubicacion in tipoubicaciones">
                    </select>
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '2'">
                <div class="form-group" >
                    <input type="text" class="form-control" ng-model="Producto.proveedores_sugeridos" placeholder="Proveedores Sugeridos">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '13' || Producto.tipo_producto == '14'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.numero_contrato" placeholder="Numero de Contrato">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '10' || Producto.tipo_producto == '14'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.numero_requerimiento" placeholder="Numero de Requerimiento">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '10' || Producto.tipo_producto == '1' || Producto.tipo_producto == '7'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.valor" placeholder="Valor (Sin IVA)">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '10' || Producto.tipo_producto == '1' || Producto.tipo_producto == '7'">
                <div class="form-group">
                    <select ng-model="Producto.moneda" class="form-control" ng-options="moneda.id as moneda.nombre for moneda in monedas">
                    </select>
                    <!--
                    <input type="text" class="form-control" ng-model="Producto.moneda" placeholder="Moneda">
                    -->
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '10' || Producto.tipo_producto == '7'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.fecha_inicio" placeholder="Fecha Inicio">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '10' || Producto.tipo_producto == '7'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.fecha_terminacion" placeholder="Fecha Fin">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '10' || Producto.tipo_producto == '1' || Producto.tipo_producto == '7'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.numero_contrato_marco" placeholder="Numero de Contrato o Contrato Marco">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '14' || Producto.tipo_producto == '1'">
                <div class="form-group">
                    <select ng-model="Producto.tipo_contrato" class="form-control" ng-options="tipocontrato.id as tipocontrato.nombre for tipocontrato in tipocontratos">
                    </select>

                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '14' || Producto.tipo_producto == '1'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.tipo_contrato_cual" placeholder="Cual?">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '12'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.numero_pedido_ot_od_os" placeholder="Numero de Pedido para OT/OD/OS">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '11'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.numero_orden_compra" placeholder="Numero Orden de Compra">
                </div>
            </div>
            <div class="col-lg-4" ng-if="Producto.tipo_producto == '4'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.nit" placeholder="NIT">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-8" ng-if="Producto.tipo_producto == '4'">
                <div class="form-group">
                    <input type="text" class="form-control" ng-model="Producto.razon_social" placeholder="Razon Social">
                </div>
            </div>
        </div>
	</div>
	<hidden ng-model="Producto.id" />

	<div class="panel panel-footer">
	<div class="row">
		<div class="col-lg-4" style="text-align:left">
					<input type="button" class="btn btn-primary" value="Asignar" ng-click="asignarResponsable()" admin_action="Si"  />
					<input type="button" class="btn btn-primary" value="Cambiar Estado" ng-click="cambiarEstado()"  admin_action="Si" />		
		</div>
		<div class="col-lg-4" style="text-align:center">
					<input type="button" class="btn btn-primary" value="Anexar Documentos" ng-click="anexarDocumentos()" admin_action="Si" />		
		</div>
		<div class="col-lg-4" style="text-align:right">
					<input type="button" ng-click="eliminar()" class="btn btn-danger" value="Eliminar" admin_action="Si" />		
					<input type="submit" class="btn btn-primary" value="Guardar"/>		
		</div>
		</div>
	</div>
</form>

    <modal title="Asignar responsable" visible="showModalAsignacion">
    <form role="form">
      <div class="form-group" >
        <label for="consecutivo_asignacion">Consecutivo</label>
        <input type="text" class="form-control" id="consecutivo_asignacion" ng-model="Asignacion.consecutivo" placeholder="Consecutivo" />
      </div>
      <div class="form-group" >
        <label for="tipo_actividad_asignacion">Tipo de Actividad</label>
        <input type="text" class="form-control" id="tipo_actividad_asignacion" ng-model="Asignacion.tipo_actividad" placeholder="Tipo de Actividad" />
      </div>
        <hr />
      <div class="form-group" >
        <label for="estado_actual_asignacion">Estado Actual</label>
        <input type="text" class="form-control" id="estado_actual_asignacion" placeholder="Estado Actual" />
      </div>
      <div class="form-group" >
        <label for="Accion">Accion</label>
        <input type="text" class="form-control" id="accion_asignacion" ng-model="Asignacion.accion" placeholder="Accion" />
      </div>
      <div class="form-group" >
        <label for="responsable_asignacion">Responsable</label>
        <input type="text" class="form-control" id="responsable_asignacion" ng-model="Asignacion.responsable" placeholder="Responsable" />
      </div>
      <div class="form-group" >
        <label for="consecutivo_asignacion">Fecha</label>
        <input type="text" class="form-control" id="fecha_asignacion" ng-model="Asignacion.fecha" placeholder="Fecha" />
      </div>
      <div class="form-group" >
        <label for="observaciones_asignacion">Observaciones</label>
        <textarea class="form-control" id="observaciones_asignacion" ng-model="Asignacion.observaciones" placeholder="Observaciones"></textarea>
      </div>
	<div class="panel panel-footer">
      <div class="row">
		<div class="col-lg-4" style="text-align:left">
					<input type="button" class="btn btn-primary" value="Historia" ng-click="ver_historia()" />
		</div>
		<div class="col-lg-4" style="text-align:center">
					<input type="button" class="btn btn-primary" value="Anexar Documentos"/>		
		</div>
		<div class="col-lg-4" style="text-align:right">
					<input type="button" ng-click="guardar_asignacion()" class="btn btn-danger" value="Guardar"/>
					<input type="button" class="btn btn-primary" value="Cerrar" data-dismiss="modal" aria-hidden="true"/>
		</div>
	</div>
    </div>
    </form>
  </modal>

    <modal title="Cambiar estado del proceso" visible="showModalEstado">
    <form role="form">
      <div class="form-group" >
        <label for="Estado.consecutivo">Consecutivo</label>
        <input type="text" class="form-control" id="Estado.consecutivo" ng-model="Estado.consecutivo" placeholder="Consecutivo" />
      </div>
      <div class="form-group" >
        <label for="Estado.tipo_actividad">Tipo de Actividad</label>
        <input type="text" class="form-control" id="Estado.tipo_actividad" ng-model="Estado.tipo_actividad" placeholder="Tipo de Actividad" />
      </div>
        <hr />
      <div class="form-group" >
        <label for="Estado.estado_actual">Estado Actual</label>
        <input type="text" class="form-control" id="Estado.estado_actual" ng-model="Estado.estado_actual" placeholder="Estado Actual" />
      </div>
      <div class="form-group" >
        <label for="Estado.accion">Accion</label>
        <input type="text" class="form-control" id="Estado.accion" ng-model="Estado.accion" placeholder="Accion" />
      </div>
      <div class="form-group" >
        <label for="Estado.responsable">Responsable</label>
        <input type="text" class="form-control" id="Estado.responsable" ng-model="Estado.responsable" placeholder="Responsable" />
      </div>
      <div class="form-group" >
        <label for="Estado.fecha">Fecha</label>
        <input type="text" class="form-control" id="Estado.fecha" ng-model="Estado.fecha" placeholder="Fecha" />
      </div>
      <div class="form-group" >
        <label for="Estado.observaciones">Observaciones</label>
        <textarea class="form-control" id="Estado.observaciones" ng-model="Estado.observaciones" placeholder="Observaciones"></textarea>
      </div>
<div class="panel panel-footer">
      <div class="row">
		<div class="col-lg-4" style="text-align:left">
					<input type="button" class="btn btn-primary" value="Historia" ng-click="ver_historia()" />
		</div>
		<div class="col-lg-4" style="text-align:center">
					<input type="button" class="btn btn-primary" value="Anexar Documentos"/>
		</div>
		<div class="col-lg-4" style="text-align:right">
					<input type="button" ng-click="guardar_asignacion()" class="btn btn-danger" value="Guardar"/>
					<input type="button" class="btn btn-primary" value="Cerrar" data-dismiss="modal" aria-hidden="true"/>
		</div>
	</div>
	</div>
    </form>
  </modal>

   <modal title="Anexar documentos" visible="showModalAnexo_Producto">
    <form role="form">
      <div class="form-group" >
        <label for="Anexo_Producto.consecutivo">Consecutivo</label>
        <input type="text" class="form-control" id="Anexo_Producto.consecutivo" placeholder="Consecutivo" />
      </div>
      <div class="form-group" >
        <label for="Anexo_Producto.tipo_actividad">Tipo de Actividad</label>
        <input type="text" class="form-control" id="Anexo_Producto.tipo_actividad" placeholder="Tipo de Actividad" />
      </div>
        <hr />
      <div class="form-group" >
        <label for="Anexo_Producto.anexo">Archivo (PDF, DOCX, PPTX, XLSX, ZIP):</label>
        <input type="file" class="form-control" id="Anexo_Producto.anexo" ng-model="Anexo_Producto.anexo" accept=".pdf,.doc,.docx, .ppt, .pptx, .xls, .xlsx, .zip" />
      </div>
      <div class="form-group" >
        <label for="Anexo_Producto.fecha">Fecha</label>
        <input type="text" class="form-control" id="Anexo_Producto.fecha" ng-model="Anexo_Producto.fecha" placeholder="Fecha" />
      </div>
      <div class="form-group" >
        <label for="Anexo_Producto.descripcion">Descripcion</label>
        <textarea class="form-control" id="Anexo_Producto.descripcion" ng-model="Anexo_Producto.descripcion" placeholder="Descripcion"></textarea>
      </div>
<div class="panel panel-footer">
      <div class="row">
		<div class="col-lg-4" style="text-align:left">
					<input type="button" class="btn btn-primary" value="Historia" ng-click="ver_historia()" />
		</div>
		<div class="col-lg-4" style="text-align:center">
					<input type="button" class="btn btn-primary" value="Anexar Documentos"/>
		</div>
		<div class="col-lg-4" style="text-align:right">
					<input type="button" ng-click="guardar_anexo()" class="btn btn-danger" value="Guardar"/>
					<input type="button" class="btn btn-primary" value="Cerrar" data-dismiss="modal" aria-hidden="true"/>
		</div>
	</div>
	</div>
    </form>	
  </modal>

        {% endverbatim %}
</div>
    </div>

{% endblock contenido%}

{% block js %}
<script>
	var idx = {{ id }};
	var current_user = {{request.user.id}};

	app.controller('editController',function($scope, $http, ProductoService, UserService, TipoContratoService, TipoUbicacionService, TipoObjetoService, TipoProductoService, MonedaService, PaisService, DepartamentoService, CiudadService, ClienteService, LocalizacionService) {
		
        var q_01 = UserService.query();
		var q_02 = TipoContratoService.query();
		var q_03 = TipoUbicacionService.query();
		var q_04 = TipoObjetoService.query();
		var q_05 = TipoProductoService.query();
		var q_06 = MonedaService.query();
		var q_07 = PaisService.query();
		var q_08 = DepartamentoService.query();
		var q_09 = CiudadService.query();
		var q_10 = ClienteService.query();
		var q_11 = LocalizacionService.query();
		
		q_01.$promise.then(function(data){
			$scope.users = data.results;
		});	
	
		q_02.$promise.then(function(data){
			$scope.tipocontratos = data.results;
		});	
	
		q_03.$promise.then(function(data){
			$scope.tipoubicaciones = data.results;
		});	
	
		q_04.$promise.then(function(data){
			$scope.tipoobjetos = data.results;
		});	
	
		q_05.$promise.then(function(data){
			$scope.tipoproductos = data.results;
		});	
	
		q_06.$promise.then(function(data){
			$scope.monedas = data.results;
		});	
	/*
		q_07.$promise.then(function(data){
			$scope.paises = data.results;
		});	
	
		q_08.$promise.then(function(data){
			$scope.departamentos = data.results;
		});	
	
		q_09.$promise.then(function(data){
			$scope.ciudades = data.results;
		});	
	
		q_10.$promise.then(function(data){
			$scope.clientes = data.results;
		});	
	
		q_11.$promise.then(function(data){
			$scope.localizaciones = data.results;
		});	
	*/
		if (idx != 0)
		{
			var q_producto = ProductoService.get({ id: idx }, function() {
				$scope.Producto = q_producto;	
			});
		}
		$scope.eliminar = function(){
			if (idx != 0)
			{
				console.log($scope.Producto);
				//Confirmar();
				$http.delete('/api/producto/', $scope.Producto);	

			}		
		}

		$scope.showModalAsignacion = false;
        $scope.asignarResponsable = function(){
            $scope.showModalAsignacion = !$scope.showModalAsignacion;
        };
		
		$scope.showModalEstado = false;
        $scope.cambiarEstado = function(){
            $scope.showModalEstado = !$scope.showModalEstado;
        };
		
		$scope.showModalAnexo_Producto = false;
        $scope.anexarDocumentos = function(){
            $scope.showModalAnexo_Producto = !$scope.showModalAnexo_Producto;
        };

		$scope.submit = function(){
        $scope.errors = {};

		if (idx != 0)
		{
			//ProductoService.update($scope.Producto);	
			console.log($scope.Producto);
            $http({
                  method: 'PUT',
                  url: '/api/producto/' + idx + '/',
                  data : $scope.Producto,
                }).then(function successCallback(response) {
                    //alert("Correct");
                  }, function errorCallback(response) {
                    $scope.errors = response.data;
            });

		}
		else
		{
			console.log($scope.Producto);
            $http({
                  method: 'POST',
                  url: '/api/producto/',
                  data : $scope.Producto,
                }).then(function successCallback(response) {
                    //alert("Correct");
                  }, function errorCallback(response) {
                    $scope.errors = response.data;
            });
		}
  };
});

</script>

<script>
	
	function AddMasks(){
		$("input[placeholder^='Fecha']").datepicker();
		$("input[placeholder^='Valor']").spinner({
			  step: 0.01,
			  numberFormat: "n"
		});
	}
	
	$( document ).ready(function() {
		//console.log($("input")); //.attr("ng-model", "producto.fecha_*"));
		$("#cmb_tipo_producto").change(function () {
			AddMasks();
		});
		
		AddMasks();
		
		// Ocultar los botones que no aplican
		if (idx == 0)
		{
			$("input[admin_action^='Si']").hide();
			$("#cmb_usuario").val(current_user);
		}
		else
		{
			$("#cmb_tipo_producto").prop('disabled', 'disabled');
			$("#cmb_usuario").prop('disabled', 'disabled');
			$("input[admin_action^='Si']").show();			
		}
	});		
</script>
	
{% endblock js %}